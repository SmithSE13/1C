
#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	УстановитьЗначенияПереключателейПоУмолчанию();
	
	УстановитьПутиСохраненияФайлов();

	ПрочитатьСохраненныеНастройки();
	
	НастроитьЭлементыФормы();
	
КонецПроцедуры

&НаКлиенте
Асинх Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	
	Если ЗавершениеРаботы Тогда
		СохранитьНастройкиВФайл();
		Возврат;
	КонецЕсли;

	Если ВсегдаСохранятьНастройки Тогда
		СохранитьНастройкиВФайл();
	ИначеЕсли Ждать ВопросАсинх("Сохранить настройки подключения?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да Тогда
		СохранитьНастройкиВФайл();
	Иначе
		УдалитьФайлНастроек();
	КонецЕсли;

	Если ВсегдаСохранятьНастройки Тогда
		// оставляем
	ИначеЕсли Ждать ВопросАсинх("Сохранить файл тела запроса?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
		УдалитьФайлТелаЗапроса();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ПутьДляСохраненияФайлаНастроекОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ЗапуститьПриложение(ПутьДляСохраненияФайлаНастроек);
	
КонецПроцедуры

&НаКлиенте
Процедура ПутьДляСохраненияФайлаТелаЗапросаОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ЗапуститьПриложение(ПутьДляСохраненияФайлаТелаЗапроса);
	
КонецПроцедуры

&НаКлиенте
Процедура ПереключательМоделейПриИзменении(Элемент)

	НастроитьЭлементыФормы();
	
КонецПроцедуры

&НаКлиенте
Процедура ПереключательРежимовПриИзменении(Элемент)
	
	НастроитьЭлементыФормы();
	ОчиститьРеквизитыФормы();
	
КонецПроцедуры

&НаКлиенте
Процедура ПереключательКомандПриИзменении(Элемент)
	
	Если ПереключательКоманд = "completionAsync" Тогда
		ПереключательРежимов = "Промт";
		ПереключательМоделей = "YandexGPTLite";
	КонецЕсли;
	
	НастроитьЭлементыФормы();
	ОчиститьРеквизитыФормы();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ПолучитьIAMТокен(Команда)
		
	Ответ = НоваяАвторизация();
	
	Если Ответ = Неопределено Тогда
		Возврат;
	ИначеЕсли Ответ.КодСостояния <> 200 Тогда
		ОписаниеОтветаНейросети = Ответ.ПолучитьТелоКакСтроку();
		Возврат;
	КонецЕсли;
	
	СтрокаОтвета = Ответ.ПолучитьТелоКакСтроку();
	
	Данные = JsonВКоллекцию(СтрокаОтвета, Ложь);
	Данные.Свойство("iamToken", Объект.IAMТокен);

КонецПроцедуры

&НаКлиенте
Процедура ПолучитьOAuthТокен(Команда)

	URL = URLСервиса();
	ЗапуститьПриложение(URL);

КонецПроцедуры

&НаКлиенте
Процедура ЗапроситьОтвет(Команда)
	
	ОчиститьСообщения();
	
	Если Не ПроверитьЗаполнение() Тогда
		Возврат;
	КонецЕсли;
	
	Если ПереключательРежимов = "" Тогда
		ПереключательРежимов = "Промт";
	КонецЕсли;
	
	НастроитьЭлементыФормы();
	Элементы.ГруппаОсновныеНастройкиМоделиГенерации.Скрыть();

	ОписаниеЗапросаПользователя = СокрЛП(ОписаниеЗапросаПользователя);
	
	Соединение = НовоеHTTPСоединение();	
	Если Соединение = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = НовыйHTTPЗапрос("/foundationModels/v1/" + ПереключательКоманд);

	ЗаполнитьФайлТелаЗапроса();
	Если Не ФайлЕсть(ПутьДляСохраненияФайлаТелаЗапроса) Тогда
		СообщитьПользователю("Не удалось подготовить файл тела запроса.", "ПутьДляСохраненияФайлаТелаЗапроса");
		Возврат;
	КонецЕсли;

	Запрос.УстановитьТелоИзДвоичныхДанных(Новый ДвоичныеДанные(ПутьДляСохраненияФайлаТелаЗапроса));
	Запрос.Заголовки.Вставить("Content-Type", "application/json");
	Запрос.Заголовки.Вставить("Authorization", "Bearer " + Объект.IAMТокен);
	
	Ответ = РезультатЗапроса(Соединение, Запрос);
	Если Ответ = Неопределено Тогда
		Возврат;
	ИначеЕсли Ответ.КодСостояния <> 200 Тогда
		ОписаниеОтветаНейросети = Ответ.ПолучитьТелоКакСтроку();
		Возврат;
	КонецЕсли;
	
	Если ПереключательКоманд = "completion" Тогда
		РазобратьОтветКомандыCompletion(JsonВКоллекцию(Ответ.ПолучитьТелоКакСтроку(), Ложь));
	ИначеЕсли ПереключательКоманд = "completionAsync" Тогда
		РазобратьОтветКомандыСompletionAsync(Ответ.ПолучитьТелоКакСтроку());
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапросНаПолучениеИнформацииОбОперации(Команда)
	
	Если ОтветКомандыСompletionAsync = "" Тогда
		СообщитьПользователю("Сначала сделайте запрос.", "ОписаниеЗапросаПользователя");
		Возврат;
	КонецЕсли;
	
	Соединение = НовоеHTTPСоединение();
	Если Соединение = Неопределено Тогда
		Возврат;
	КонецЕсли;

	Запрос = НовыйHTTPЗапрос("/operations/" + id);
	Запрос.Заголовки.Вставить("Authorization", "Bearer " + Объект.IAMТокен);
	
	Ответ = РезультатЗапроса(Соединение, Запрос);
	Если Ответ = Неопределено Тогда
		Возврат;
	ИначеЕсли Ответ.КодСостояния <> 200 Тогда
		ОписаниеОтветаНейросети = Ответ.ПолучитьТелоКакСтроку();
		Возврат;
	КонецЕсли;

	СоответствиеОтвета = JsonВКоллекцию(Ответ.ПолучитьТелоКакСтроку(), Ложь, Истина);
	done = СоответствиеОтвета.Получить("done");
	Если done = Истина Тогда
		response = СоответствиеОтвета.Получить("response");
		Если response <> Неопределено Тогда
			РазобратьМассивAlternatives(response.Получить("alternatives"), Истина);
		Иначе
			error = СоответствиеОтвета.Получить("error");
			ОписаниеОтветаНейросети = ?(error <> Неопределено, error.Получить("message"), 
												"<Ответ не определён. Необходимо проверить API.>");
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Функция НоваяАвторизация()

	Соединение = Новый HTTPСоединение("iam.api.cloud.yandex.net", 443, , , , , Новый ЗащищенноеСоединениеOpenSSL);
		
	Запрос = НовыйHTTPЗапрос("/iam/v1/tokens");
	
	Запрос.УстановитьТелоИзСтроки(КоллекциюВJson(Новый Структура("yandexPassportOauthToken", Объект.OAuthТокен)));
	
	Запрос.Заголовки.Вставить("Content-Type", "application/json");
	
	Ответ = Неопределено;
	Попытка
		Ответ = Соединение.ВызватьHTTPМетод("POST", Запрос);
	Исключение
		ОписаниеОтветаНейросети = ОписаниеОшибки();
	КонецПопытки;

	Возврат Ответ;
	
КонецФункции

&НаКлиенте
Функция URLСервиса()

	Возврат "https://oauth.yandex.ru/authorize?response_type=token&client_id=1a6990aa636648e9b2ef855fa7bec2fb";

КонецФункции

&НаКлиенте
Функция НовоеHTTPСоединение()

	Соединение = Неопределено;
	
	Попытка
		Соединение = Новый HTTPСоединение("llm.api.cloud.yandex.net", 443, , , , , Новый ЗащищенноеСоединениеOpenSSL);
	Исключение
		ОписаниеОтветаНейросети = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Соединение;

КонецФункции

&НаКлиенте
Функция НовыйHTTPЗапрос(URL)

	Запрос = Новый HTTPЗапрос(URL);
	
	Если Не ЛогироватьЗапросы Тогда
		Запрос.Заголовки.Вставить("x-data-logging-enabled", Ложь);
	КонецЕсли;
	
	Возврат Запрос;

КонецФункции

&НаКлиенте
Функция РезультатЗапроса(Соединение, Запрос, ИмяМетода = "POST")

	Ответ = Неопределено;
	
	Попытка
		Ответ = Соединение.ВызватьHTTPМетод(ИмяМетода, Запрос);
	Исключение
		ОписаниеОтветаНейросети = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Ответ;
	
КонецФункции

&НаКлиенте
Процедура СообщитьПользователю(Текст, Поле)
	
	Сообщение = Новый СообщениеПользователю;
	Сообщение.Текст = Текст;
	Сообщение.Поле = Поле;
	Сообщение.УстановитьДанные(Элементы.Найти(Поле));
	Сообщение.Сообщить();

КонецПроцедуры

&НаКлиенте
Функция JsonВКоллекцию(JSON, ЭтоФайл, ВСоответствие = Ложь)

	ЧтениеJSON = Новый ЧтениеJSON;
	Если ЭтоФайл Тогда
		ЧтениеJSON.ОткрытьФайл(JSON);
	Иначе
		ЧтениеJSON.УстановитьСтроку(JSON);
	КонецЕсли;
	Коллекция = ПрочитатьJSON(ЧтениеJSON, ВСоответствие);
	ЧтениеJSON.Закрыть();
	
	Возврат Коллекция;
	
КонецФункции

&НаКлиенте
Функция КоллекциюВJson(Коллекция, ЗаписьВФайл = Ложь, ИмяФайла = "")
	
	ЗаписьJSON = Новый ЗаписьJSON;
	Если ЗаписьВФайл Тогда
		ЗаписьJSON.ОткрытьФайл(ИмяФайла);	
	Иначе
		ЗаписьJSON.УстановитьСтроку();
	КонецЕсли;
	
	ЗаписатьJSON(ЗаписьJSON, Коллекция);
		
	Возврат ЗаписьJSON.Закрыть();
	
КонецФункции

&НаКлиенте
Процедура УстановитьПутиСохраненияФайлов()
	
	Каталог = КаталогВременныхФайлов();
	ПутьДляСохраненияФайлаТелаЗапроса = Каталог + "телоЗапроса.json";	
	ПутьДляСохраненияФайлаНастроек 	  = Каталог + "сохраненныеДанные.json";
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьЗначенияПереключателейПоУмолчанию()
	
	ПереключательМоделей = "YandexGPTLite";
	ПереключательРежимов = "Промт";
	ПереключательКоманд = "completion";
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьНастройкиВФайл()

	Структура = Новый Структура;
	Структура.Вставить("ИдентификаторКаталога", Объект.ИдентификаторКаталога);
	Структура.Вставить("OAuthТокен", Объект.OAuthТокен);
	Структура.Вставить("IAMТокен", Объект.IAMТокен);
	Структура.Вставить("ЗадачаДляНейросети", Объект.ЗадачаДляНейросети);
	
	Структура.Вставить("ВсегдаСохранятьНастройки", ВсегдаСохранятьНастройки);
	
	Структура.Вставить("temperature", temperature);
	Структура.Вставить("stream", stream);
	Структура.Вставить("maxTokens", maxTokens);
	Структура.Вставить("ЛогироватьЗапросы", ЛогироватьЗапросы);
	
	Структура.Вставить("ПереключательМоделей", ПереключательМоделей);
	Структура.Вставить("ПереключательРежимов", ПереключательРежимов);
	Структура.Вставить("ПереключательКоманд", ПереключательКоманд);
	
	КоллекциюВJson(Структура, Истина, ПутьДляСохраненияФайлаНастроек);

КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьСохраненныеНастройки()

	Если ФайлЕсть(ПутьДляСохраненияФайлаНастроек) Тогда
		Структура = JsonВКоллекцию(ПутьДляСохраненияФайлаНастроек, Истина);
		ЗаполнитьЗначенияСвойств(Объект, Структура);
		ЗаполнитьЗначенияСвойств(ЭтаФорма, Структура);
	Иначе
		temperature = 0.1;
		maxTokens = "1000";
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьФайлТелаЗапроса()

	Данные = ДанныеСompletionOptions();
	СформироватьMessages(Данные);	
	КоллекциюВJson(Данные, Истина, ПутьДляСохраненияФайлаТелаЗапроса);
		
КонецПроцедуры

&НаКлиенте
Процедура УдалитьФайлТелаЗапроса()

	Если ФайлЕсть(ПутьДляСохраненияФайлаТелаЗапроса) Тогда
		УдалитьФайлы(ПутьДляСохраненияФайлаТелаЗапроса);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура УдалитьФайлНастроек()
	
	Если ФайлЕсть(ПутьДляСохраненияФайлаНастроек) Тогда
		УдалитьФайлы(ПутьДляСохраненияФайлаНастроек);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Функция ФайлЕсть(ИмяФайла)

	Файл = Новый Файл(ИмяФайла);
	ФайлЕсть = Файл.Существует();
	Возврат ФайлЕсть;
	
КонецФункции

&НаКлиенте
Процедура НастроитьЭлементыФормы()

	Если Не ЗначениеЗаполнено(Объект.ИдентификаторКаталога) 
					Или Не ЗначениеЗаполнено(Объект.OAuthТокен) 
						Или Не ЗначениеЗаполнено(Объект.IAMТокен) Тогда	
		Элементы.ГруппаАвторизация.Показать();
	Иначе
		Элементы.ГруппаАвторизация.Скрыть();
	КонецЕсли;

	Если ПереключательМоделей = "КраткийПересказ" Тогда
		Элементы.ОписаниеЗапросаПользователя.Заголовок = "Статья к пересказу";
		ПереключательРежимов = "";
		Элементы.ПереключательРежимов.Доступность = Ложь;
		Элементы.ЗадачаДляНейросети.Видимость = Ложь;
		Элементы.ДекорацияМодель.Заголовок = Элементы.ПереключательМоделей.СписокВыбора.НайтиПоЗначению(ПереключательМоделей);
		Элементы.ДекорацияРежим.Заголовок = "";
	ИначеЕсли ПереключательМоделей = "YandexGPTLite" Тогда
		Элементы.ОписаниеЗапросаПользователя.Заголовок = "Запрос пользователя";
		Элементы.ПереключательМоделей.Доступность = Не ПереключательКоманд = "completionAsync";
		Элементы.ПереключательРежимов.Доступность = Не ПереключательКоманд = "completionAsync";
		Элементы.ЗадачаДляНейросети.Видимость = Истина;
		Элементы.ДекорацияМодель.Заголовок = Элементы.ПереключательМоделей.СписокВыбора.НайтиПоЗначению(ПереключательМоделей);
		Элементы.ДекорацияРежим.Заголовок = Элементы.ПереключательРежимов.СписокВыбора.НайтиПоЗначению(ПереключательРежимов);
	КонецЕсли;

	Элементы.ДекорацияКоманда.Заголовок = Элементы.ПереключательКоманд.СписокВыбора.НайтиПоЗначению(ПереключательКоманд);

	Элементы.ГруппаАсинхронно.Видимость = ПереключательКоманд = "completionAsync";
	
	Элементы.ГруппаПараметры.Видимость = Не ПереключательКоманд = "completionAsync";
	
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьРеквизитыФормы()

	messagesПользователяJson = "";
	messageАссистентаJson = "";
	ОтветКомандыСompletionAsync = "";
	
	ОписаниеЗапросаПользователя = "";
	ОписаниеОтветаНейросети = "";

КонецПроцедуры

&НаКлиенте
Функция ДанныеСompletionOptions()
	
	Если ПереключательМоделей = "YandexGPTLite" Тогда
		МодельСтрокаUri = "/yandexgpt-lite";
	ИначеЕсли ПереключательМоделей = "КраткийПересказ" Тогда
		МодельСтрокаUri = "/summarization";
	КонецЕсли;

	Данные = Новый Структура;
	Данные.Вставить("modelUri", "gpt://" + Объект.ИдентификаторКаталога + МодельСтрокаUri);
	Данные.Вставить("completionOptions", Новый Структура("stream, temperature, maxTokens", 
														  stream, temperature, maxTokens));

	Возврат Данные; 

КонецФункции

&НаКлиенте
Функция РольТекст(Роль, Текст)

	Возврат Новый Структура("role, text", Роль, Текст);

КонецФункции

&НаКлиенте
Процедура СформироватьMessages(СтруктураДанных)

	messagesПользователяМассив = Новый Массив;
	
	Если ПереключательМоделей = "YandexGPTLite" Тогда
		
		messagesПользователяМассив.Добавить(РольТекст("system", Объект.ЗадачаДляНейросети));
		
		Если ПереключательРежимов = "Промт" Тогда
			
			messagesПользователяМассив.Добавить(РольТекст("user", ОписаниеЗапросаПользователя));
			
		ИначеЕсли ПереключательРежимов = "Чат" Тогда
			
			Если messagesПользователяJson = "" Тогда
				messagesПользователяМассив.Добавить(РольТекст("user", ОписаниеЗапросаПользователя));
				messagesПользователяJson = КоллекциюВJson(messagesПользователяМассив);
			Иначе
				messagesПользователяМассив = JsonВКоллекцию(messagesПользователяJson, Ложь);
				messagesПользователяМассив.Добавить(JsonВКоллекцию(messageАссистентаJson, Ложь));
				messagesПользователяМассив.Добавить(РольТекст("user", ОписаниеЗапросаПользователя));
				messagesПользователяJson = КоллекциюВJson(messagesПользователяМассив);
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ПереключательМоделей = "КраткийПересказ" Тогда
		messagesПользователяМассив.Добавить(РольТекст("user", ОписаниеЗапросаПользователя));
	КонецЕсли;

	СтруктураДанных.Вставить("messages", messagesПользователяМассив);
	
КонецПроцедуры
		
&НаКлиенте
Процедура РазобратьОтветКомандыCompletion(СтруктураДанных)

	result = Неопределено;
	СтруктураДанных.Свойство("result", result);
	
	alternatives = Неопределено;
	result.Свойство("alternatives", alternatives);
	result.Свойство("modelVersion", modelVersion);
	
	usage = Неопределено;
	result.Свойство("usage", usage);
	ЗаполнитьЗначенияСвойств(ЭтаФорма, usage);

	РазобратьМассивAlternatives(alternatives);
	
КонецПроцедуры

&НаКлиенте
Процедура РазобратьОтветКомандыСompletionAsync(JsonСтрока)	

	ОтветКомандыСompletionAsync = JsonСтрока;
	
	СтруктураОтвета = JsonВКоллекцию(ОтветКомандыСompletionAsync, Ложь);
	СтруктураОтвета.Свойство("id", id);
	
	ОписаниеОтветаНейросети = JsonСтрока;
	
КонецПроцедуры

&НаКлиенте
Процедура РазобратьМассивAlternatives(Массив, ЭтоМассивСоответствий = Ложь)

	messageАссистента = Неопределено;
	
	Если Не ЭтоМассивСоответствий Тогда
		
		Если ТипЗнч(Массив) = Тип("Массив") И Массив.Количество() > 0 Тогда
			Для каждого Структура Из Массив Цикл
				Структура.Свойство("message", messageАссистента);
				Структура.Свойство("status", status);			
			КонецЦикла;
		КонецЕсли;
		ОписаниеОтветаНейросети = messageАссистента.text;
	Иначе
		
		Если ТипЗнч(Массив) = Тип("Массив") И Массив.Количество() > 0 Тогда
			Для каждого Соответствие Из Массив Цикл
				messageАссистента = Соответствие.Получить("message");
				status = Соответствие.Получить("status");			
			КонецЦикла;
		КонецЕсли;
		ОписаниеОтветаНейросети = messageАссистента.Получить("text");
	КонецЕсли;
	
	Если ПереключательРежимов = "Чат" Тогда
		messageАссистентаJson = КоллекциюВJson(messageАссистента)
	КонецЕсли;
		
КонецПроцедуры
	
#КонецОбласти